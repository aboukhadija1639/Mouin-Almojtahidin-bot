import { getUserInfo, isUserAdmin } from '../utils/database.js';
import { config } from '../../config.js';

export async function handleHelp(ctx) {
  try {
    const userId = ctx.from.id;
    const userInfo = await getUserInfo(userId);
    const isAdmin = await isUserAdmin(userId);

    // Build help message
    let message = `ğŸ†˜ *Ø¯Ù„ÙŠÙ„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙˆØª Ù…Ø¹ÙŠÙ† Ø§Ù„Ù…Ø¬ØªÙ‡Ø¯ÙŠÙ†*\\n\\n`;
    
    message += `Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¨ÙˆØª Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©\\! ğŸ“š\\n\\n`;
    
    // Public commands (available to all users)
    message += `ğŸŒ *Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¹Ø§Ù…Ø©:*\\n\\n`;
    
    message += `ğŸ  \`/start\` \\- Ø¨Ø¯Ø¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØª\\n`;
    message += `   â€¢ ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯\\n`;
    message += `   â€¢ Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨\\n\\n`;
    
    message += `ğŸ” \`/verify ÙƒÙˆØ¯_Ø§Ù„ØªÙØ¹ÙŠÙ„\` \\- ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨\\n`;
    message += `   â€¢ ØªÙØ¹ÙŠÙ„ Ø­Ø³Ø§Ø¨Ùƒ Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙŠØ²Ø§Øª\\n`;
    message += `   â€¢ Ù…Ø«Ø§Ù„: \`/verify ${config.users.activationCode}\`\\n\\n`;
    
    message += `ğŸ†˜ \`/help\` \\- Ø¹Ø±Ø¶ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©\\n`;
    message += `   â€¢ Ø¯Ù„ÙŠÙ„ Ø´Ø§Ù…Ù„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙˆØ§Ù…Ø±\\n\\n`;

    // User commands (requires verification)
    if (userInfo && userInfo.is_verified) {
      message += `ğŸ‘¤ *Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙØ¹Ù„:*\\n\\n`;
      
      message += `ğŸ‘¤ \`/profile\` \\- Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ\\n`;
      message += `   â€¢ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©\\n`;
      message += `   â€¢ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª\\n\\n`;
      
      message += `ğŸ“š \`/courses\` \\- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø±ÙˆØ³\\n`;
      message += `   â€¢ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„Ø©\\n`;
      message += `   â€¢ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ ÙˆØ§Ù„Ø£ÙˆÙ‚Ø§Øª\\n\\n`;
      
      message += `ğŸ“ \`/assignments\` \\- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª\\n`;
      message += `   â€¢ Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø© ÙˆØ§Ù„Ù…Ù†ØªÙ‡ÙŠØ©\\n`;
      message += `   â€¢ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©\\n\\n`;
      
      message += `âœ… \`/attendance Ø±Ù‚Ù…_Ø§Ù„Ø¯Ø±Ø³\` \\- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±\\n`;
      message += `   â€¢ ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±Ùƒ ÙÙŠ Ø¯Ø±Ø³ Ù…Ø¹ÙŠÙ†\\n`;
      message += `   â€¢ Ù…Ø«Ø§Ù„: \`/attendance 1\`\\n\\n`;
      
      message += `ğŸ“¤ \`/submit Ø±Ù‚Ù…_Ø§Ù„ÙˆØ§Ø¬Ø¨ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©\` \\- Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø¬Ø§Ø¨Ø©\\n`;
      message += `   â€¢ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø¬Ø§Ø¨Ø© ÙˆØ§Ø¬Ø¨ Ù…Ø¹ÙŠÙ†\\n`;
      message += `   â€¢ Ù…Ø«Ø§Ù„: \`/submit 1 Ù‡Ø°Ù‡ Ø¥Ø¬Ø§Ø¨ØªÙŠ\`\\n\\n`;
      
      message += `ğŸ”” \`/reminders\` \\- ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØªØ°ÙƒÙŠØ±Ø§Øª\\n`;
      message += `   â€¢ ØªÙØ¹ÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù ØªØ°ÙƒÙŠØ±Ø§Øª Ø§Ù„Ø¯Ø±ÙˆØ³\\n\\n`;
      
      message += `â“ \`/faq\` \\- Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©\\n`;
      message += `   â€¢ Ø¥Ø¬Ø§Ø¨Ø§Øª Ù„Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©\\n\\n`;
    } else if (userInfo && !userInfo.is_verified) {
      message += `âš ï¸ *Ù…Ù„Ø§Ø­Ø¸Ø©:* Ø­Ø³Ø§Ø¨Ùƒ ØºÙŠØ± Ù…ÙØ¹Ù„\\! Ø§Ø³ØªØ®Ø¯Ù… \`/verify\` Ù…Ø¹ ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„ Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙŠØ²Ø§Øª\\.\n\n`;
    } else {
      message += `âš ï¸ *Ù…Ù„Ø§Ø­Ø¸Ø©:* Ù„Ù… ØªØ³Ø¬Ù„ Ø­Ø³Ø§Ø¨Ø§Ù‹ Ø¨Ø¹Ø¯\\! Ø§Ø³ØªØ®Ø¯Ù… \`/start\` Ø£ÙˆÙ„Ø§Ù‹\\.\n\n`;
    }

    // Admin commands (admin only)
    if (isAdmin) {
      message += `âš™ï¸ *Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…Ø¯ÙŠØ±:*\\n\\n`;
      
      message += `ğŸ“Š \`/stats\` \\- Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª\\n`;
      message += `   â€¢ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø´Ø§Ù…Ù„Ø© Ù„Ù„Ø¨ÙˆØª\\n`;
      message += `   â€¢ Ø£Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„Ø­Ø¶ÙˆØ±\\n\\n`;
      
      message += `ğŸ“¢ \`/publish Ù†Øµ_Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†\` \\- Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù†\\n`;
      message += `   â€¢ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø¹Ù„Ø§Ù† Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†\\n\\n`;
      
      message += `â• \`/addassignment\` \\- Ø¥Ø¶Ø§ÙØ© ÙˆØ§Ø¬Ø¨ Ø¬Ø¯ÙŠØ¯\\n`;
      message += `   â€¢ Ø¥Ø¶Ø§ÙØ© ÙˆØ§Ø¬Ø¨ Ø¨Ø³Ø¤Ø§Ù„ ÙˆØ¥Ø¬Ø§Ø¨Ø©\\n\\n`;
      
      message += `âœï¸ \`/updateassignment Ø±Ù‚Ù…_Ø§Ù„ÙˆØ§Ø¬Ø¨\` \\- ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ø¨\\n`;
      message += `   â€¢ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ø¬Ø¨ Ù…ÙˆØ¬ÙˆØ¯\\n\\n`;
      
      message += `ğŸ—‘ï¸ \`/deleteassignment Ø±Ù‚Ù…_Ø§Ù„ÙˆØ§Ø¬Ø¨\` \\- Ø­Ø°Ù ÙˆØ§Ø¬Ø¨\\n`;
      message += `   â€¢ Ø­Ø°Ù ÙˆØ§Ø¬Ø¨ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹\\n\\n`;
    }

    // Tips and notes
    message += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\\n`;
    message += `ğŸ’¡ *Ù†ØµØ§Ø¦Ø­ Ù…Ù‡Ù…Ø©:*\\n\\n`;
    message += `â€¢ ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ Ø­Ø³Ø§Ø¨Ùƒ Ø£ÙˆÙ„Ø§Ù‹\\n`;
    message += `â€¢ Ø§Ø­ÙØ¸ ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„ ÙÙŠ Ù…ÙƒØ§Ù† Ø¢Ù…Ù†\\n`;
    message += `â€¢ ÙØ¹Ù‘Ù„ Ø§Ù„ØªØ°ÙƒÙŠØ±Ø§Øª Ù„Ø¹Ø¯Ù… ØªÙÙˆÙŠØª Ø§Ù„Ø¯Ø±ÙˆØ³\\n`;
    message += `â€¢ ØªØ§Ø¨Ø¹ Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª ÙˆÙ…ÙˆØ§Ø¹ÙŠØ¯Ù‡Ø§ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©\\n\\n`;
    
    message += `ğŸ”— *Ø±ÙˆØ§Ø¨Ø· Ù…ÙÙŠØ¯Ø©:*\\n\\n`;
    message += `â€¢ Ø¯Ø¹Ù… ÙÙ†ÙŠ: ${config.admin.supportChannel.replace(/@/g, '\\@')}\\n`;
    message += `â€¢ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø±ÙˆØ³: [Ø§Ù†Ù‚Ø± Ù‡Ù†Ø§](${config.zoom.fullLink})\\n\\n`;
    
    message += `ğŸ“± *Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©:*\\n\\n`;
    message += `â€¢ Ø§Ù„Ø¨ÙˆØª Ù…ØªØ§Ø­ 24/7\\n`;
    message += `â€¢ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø£Ù…Ø§Ù†\\n`;
    message += `â€¢ ÙŠØ¯Ø¹Ù… Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©\\n\\n`;
    
    message += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\\n`;
    message += `ğŸ¤– *Ø¨ÙˆØª Ù…Ø¹ÙŠÙ† Ø§Ù„Ù…Ø¬ØªÙ‡Ø¯ÙŠÙ†* \\- Ù†Ø³Ø®Ø© 1\\.0\\.0\\n`;
    message += `ğŸ“… Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${new Date().toLocaleDateString('ar-SA')}`;

    await ctx.reply(message, { 
      parse_mode: 'MarkdownV2',
      disable_web_page_preview: true 
    });

  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø£Ù…Ø± /help:', error);
    await ctx.reply(`âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø£Ùˆ ØªÙˆØ§ØµÙ„ Ù…Ø¹ ${config.admin.supportChannel}`);
  }
}